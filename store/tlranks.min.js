var hostname="76.104.218.28/tlranks";var dbLifespan=6048E5;var cacheLifespan=1728E5;window.onload=function(){onTLPageLoaded($("body"))};function loadPage(url,onSuccess,tlUser){$.ajax({url:url,success:function(html){onSuccess($(stripRelativeSrc(html)),tlUser)}})}function stripRelativeSrc(html){return html.replace(/src="\/.*?"/g,"")}
function onTLPageLoaded(html){var tlUsers=getUsersFromForum(html);testDBExists(onDBFound,onDBNotFound);function onDBFound(){$.each(tlUsers,function(){if(!getUserFromLocal(this))getUserFromDB(this)})}function onDBNotFound(){$.each(tlUsers,function(){if(!getUserFromLocal(this))searchForTLUser(this)})}}
function getUserFromLocal(tlUser){var userStr=localStorage[tlUser.name];if(userStr){var user=JSON.parse(userStr);if(!isUserExpired(user,cacheLifespan)){updateForumUser(user,tlUser);return true}}return false}function isUserExpired(user,lifespan){if(user.date===undefined)return true;var timestamp=new Date(user.date);var now=new Date;return now-timestamp>lifespan}
function searchForTLUser(tlUser){var searchURL="http://sc2ranks.com/search/exact/all/"+simplifyName(tlUser.name);loadPage(searchURL,onSearchPageLoad,tlUser)}function testDBExists(onDBFound,onDBNotFound){$.ajax({url:"http://"+hostname+"/get_user.php",dataType:"json",success:onDBFound,error:onDBNotFound})}
function getUserFromDB(tlUser){$.ajax({url:"http://"+hostname+"/get_user.php",data:{name:simplifyName(tlUser.name)},dataType:"json",success:function(user){if(user.profile===undefined||isUserExpired(user,dbLifespan))searchForTLUser(tlUser);else if(user.modes.length>0){user.modes[0].league=getLeague(user.modes[0].leagueIndex);user.modes[0].race=getRace(user.modes[0].race);user.region=getRegion(user.region.charAt(0));updateForumUser(user,tlUser)}else addUserToLocal(tlUser.name,user)},error:function(e){console.log(e.message)}})}
function onSearchPageLoad(html,tlUser){if(html[1].innerText.indexOf("Searching")===0)parseSearchPage(html,tlUser);else parseProfilePage(html,tlUser)}
function parseSearchPage(html,tlUser){var targetName=html[1].innerText.split(" ")[2];var users=[];var userHtml=$(html[31]).find(".tblrow");$.each(userHtml,function(){var user={};var link=$(this).find(".character0")[0];user.name=link.innerText;user.profile=extractString(link.innerHTML);user.region=$(this).find(".region")[0].innerText;var leagueAndTier=$(this).find(".points")[0].children[0].alt;user.league=leagueAndTier.substr(0,leagueAndTier.indexOf("-"));user.tier=leagueAndTier.substr(leagueAndTier.length-
1)-1;user.points=$(this).find(".number")[0].innerText;user.leagueIndex=getLeagueIndex(user.league);users.push(user)});if(users.length>0){sortUsersByRank(users);var bestUser=null;for(var i=0;i<users.length;i++)if(users[i].name===targetName){bestUser=users[i];break}if(bestUser!==null)loadPage("http://sc2ranks.com"+bestUser.profile,parseProfilePage,tlUser);else addMissingUserToDB(tlUser.name)}else addMissingUserToDB(tlUser.name)}
function sortUsersByRank(users){users.sort(function(a,b){if(a.leagueIndex!==b.leagueIndex)return b.leagueIndex-a.leagueIndex;else if(a.points!==b.points)return b.points-a.points;return 0})}
function parseProfilePage(html,tlUser){var user={};var nameAndRegion=html.find(".name")[0];user.name=nameAndRegion.children[0].innerText;user.region=nameAndRegion.innerText.match(/\((.*?)\)/)[1];var address=extractString(html.find(".maps")[0].children[0].outerHTML);user.profile=address.substr(0,address.length-6);user.modes=[];var leagueTables=html.find(".leagues");$.each(leagueTables,function(){var header=$(this).find(".headertext");if(header.length>0){var mode={};mode.name=parseInt(header[0].innerText.charAt(0),
10);mode.game=header[0].innerText.charAt(9);var numbers=$(this).find(".number");var leagueAndTier=$(this).find(".badge")[1].className;mode.league=leagueAndTier.split("badge-")[1].trim();mode.leagueIndex=getLeagueIndex(mode.league);mode.tier=leagueAndTier.substr(leagueAndTier.length-1)-1;mode.worldRank=numFromStr(numbers[0].innerText);mode.points=numFromStr(numbers[1].innerText);mode.race=$(this).find(".character")[0].children[0].className;mode.divisionRank=numbers[2]!==undefined?numFromStr(numbers[2].innerText):
null;mode.regionRank=numbers[3]!==undefined?numFromStr(numbers[3].innerText):null;mode.wins=parseInt($(this).find(".green")[0].innerText,10);var red=$(this).find(".red");mode.losses=red[0]!==undefined?parseInt(red[0].innerText,10):0;user.modes.push(mode)}});addUserToDB(user);if(user.modes.length>0&&user.modes[0].name===1)updateForumUser(user,tlUser)}function simplifyName(name){return name.replace(/\W/g,"")}
function numFromStr(str){var matches=str.match(/\d{1,3}([,]\d{3})*$/);var noCommas=matches[0].replace(",","");return parseInt(noCommas,10)}function extractString(html){var quotedStr=html.match(/".*?"/)[0];return quotedStr.substr(1,quotedStr.length-2)}
function updateForumUser(user,tlUser){if(user.modes===undefined||user.modes.length===0)return;var s=tlUser.header.innerHTML.split("&nbsp;");var profileLink=getProfileLink(tlUser.name,user);var leagueIcon=getLeagueIcon(user.modes[0].league,user.modes[0].tier);var raceIcon=getRaceIcon(user.modes[0].race);tlUser.header.innerHTML="&nbsp;"+getRegionIcon(user.region,user.modes[0].game)+"&nbsp;"+s[1]+"&nbsp;"+profileLink+"&nbsp;"+leagueIcon+raceIcon+s[3];addUserToLocal(tlUser.name,user)}
function addUserToLocal(name,user){localStorage[name]=JSON.stringify(user)}
function getRegionIcon(region,game){var color;var gameName;switch(game){case "H":color="#60237b";gameName="Heart of the Swarm";break;case "W":color="#194984";gameName="Wings of Liberty";break;default:color="#000";break}var versionURL=getURL("images/"+game+".png");return"<span style='color:"+color+";font-weight:bold;'>"+region+" </span><img style='width:18px;height:22px;vertical-align:middle;' src='"+versionURL+"' title='"+gameName+"' alt='"+game+"' />"}
function getLeagueIcon(league,tier){var url=getURL("images/"+league+"_"+tier+".png");league=capitaliseFirstLetter(league);return"<img style='vertical-align:middle;' src='"+url+"' title='"+league+"' alt='"+league+"'>"}function getRaceIcon(race){var url=getURL("images/"+race+".png");race=capitaliseFirstLetter(race);return"<img style='vertical-align:middle;' src='"+url+"' title='"+race+"' alt='"+race+"'>"}
function getURL(url){if(chrome===undefined||chrome.extension===undefined)return url;return chrome.extension.getURL(url)}function getProfileLink(name,user){var wins=user.modes[0].wins;var losses=user.modes[0].losses;var percent=wins+losses==0?"0.00":(wins/(wins+losses)*100).toFixed(2);return"<a target='_blank' href='http://sc2ranks.com"+user.profile+"' title='1v1 Record: "+wins+"-"+losses+" ("+percent+"%)'/>"+name+"</a>"}
function getUsersFromForum(html){var users=[];var userHeaders=html.find(".forummsginfo");$.each(userHeaders,function(){if(this.localName==="span"){var user={};if(this.children.length>1)user.name=this.children[1].innerText;else user.name=this.innerHTML.split("&nbsp;")[2].trim();user.header=$(this)[0];users.push(user)}});return users}var leagues=["bronze","silver","gold","platinum","diamond","master","grandmaster"];function getLeagueIndex(league){return leagues.indexOf(league.toLowerCase())}
function getLeague(index){return leagues[index]}function addUserToDB(user){$.ajax({type:"POST",url:"http://"+hostname+"/add_user.php",data:user,success:function(data){if(data.length>0)console.log(data)},error:function(e){console.log(e.message)}})}function addMissingUserToDB(name){var user={name:simplifyName(name),date:(new Date).toJSON(),profile:null,region:null};addUserToDB(user);addUserToLocal(name,user)}
function getRace(letter){switch(letter){case "z":return"zerg";case "t":return"terran";case "p":return"protoss";case "r":return"random"}}function getRegion(letter){switch(letter){case "A":return"AM";case "C":return"CN";case "K":return"KR";case "E":return"EU";case "S":return"SEA";default:return""}}function capitaliseFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)};